# HTML游戏上传功能 - Bug修复实施计划

## 概述

本文档将HTML游戏上传功能的三个bug修复转换为一系列代码修改任务。每个任务都建立在前面任务的基础上，最终确保上传功能正常工作。

## 实施任务

- [x] 1. 修复后端Description字段强制要求
  - 修改 `game_server_factory/main.py` 中的 `HTMLGameUploadRequest` 模型
  - 将 description 字段改为可选，默认值为空字符串
  - 修改 `/upload` 端点的 description 参数为可选
  - 确保 GameServerInstance 模型中 description 字段始终有值
  - _需求: 1.1, 1.2, 1.3_

- [x] 2. 改进Docker容器端口分配机制
  - 在 `game_server_factory/docker_manager.py` 中添加 `_get_used_ports()` 方法
  - 改进 `_find_available_port()` 方法，考虑Docker容器已使用的端口
  - 添加端口冲突检测逻辑
  - 添加详细的日志记录
  - _需求: 3.1, 3.2, 3.4_

- [x] 3. 改进容器创建和错误处理
  - 修改 `create_html_game_server()` 方法，添加完整的错误处理
  - 添加容器创建失败时的清理机制
  - 添加镜像构建失败时的清理机制
  - 添加容器启动验证
  - 改进错误日志记录
  - _需求: 3.3, 3.5, 3.6_

- [x] 4. 修复Dart客户端类型转换问题
  - 修改 `mobile_app/universal_game_client/lib/models/game_server_instance.dart`
  - 改进 `fromJson()` 方法的类型安全处理
  - 添加 `_parseDateTime()` 辅助方法
  - 添加 `_parseLogsList()` 辅助方法
  - 确保所有字段都有默认值
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 5. 测试Description字段修复
  - 编写单元测试验证Description为空时的处理
  - 编写集成测试验证上传流程
  - 验证Dart客户端能正确解析空Description
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 6. 测试端口分配和容器创建
  - 编写单元测试验证端口分配逻辑
  - 编写集成测试验证多次上传的容器独立性
  - 验证容器创建失败时的清理
  - 验证容器状态报告的准确性
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 7. 端到端集成测试
  - 测试完整的上传流程（带Description）
  - 测试完整的上传流程（不带Description）
  - 测试多次上传不同游戏
  - 验证所有容器都正常运行
  - 验证端口分配正确
  - 验证错误恢复机制
  - _需求: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 8. 检查点 - 确保所有修复完成
  - 确保所有测试通过
  - 验证三个问题都已解决
  - 检查代码质量和日志记录
  - 如有问题请询问用户

## 成功标准

- [ ] Description字段可选，用户可以不填写
- [ ] 上传成功后不出现类型转换错误
- [ ] 多次上传的容器都能正常运行
- [ ] 每个容器都有唯一的端口分配
- [ ] 容器创建失败时能正确清理资源
- [ ] 所有测试都通过
- [ ] 代码遵循现有的编程规范
- [ ] 日志记录完整且有用
