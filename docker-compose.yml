# 增强的Docker Compose配置 - 需求 7.1, 7.2, 7.4, 7.5

services:
  # 撮合服务
  matchmaker:
    build: 
      context: ./matchmaker_service/matchmaker
      dockerfile: Dockerfile
    ports:
      - "${MATCHMAKER_PORT:-8000}:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - HOST=0.0.0.0
      - PORT=8000
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - HEARTBEAT_TIMEOUT=${HEARTBEAT_TIMEOUT:-30}
      - CLEANUP_INTERVAL=${CLEANUP_INTERVAL:-10}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
    volumes:
      - matchmaker_logs:/app/logs
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - game-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 游戏服务器工厂
  game-server-factory:
    build:
      context: ./game_server_factory
      dockerfile: Dockerfile
    ports:
      - "${FACTORY_PORT:-8080}:8080"
      # 动态容器将自己管理端口映射
    environment:
      - PYTHONUNBUFFERED=1
      - HOST=0.0.0.0
      - PORT=8080
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-1048576}
      - MAX_CONTAINERS=${MAX_CONTAINERS:-50}
      - DOCKER_NETWORK=game-network
      - BASE_PORT=${BASE_PORT:-8082}
      - MATCHMAKER_URL=http://matchmaker:8000
      - IDLE_TIMEOUT_SECONDS=${IDLE_TIMEOUT_SECONDS:-1800}
      - CLEANUP_INTERVAL_SECONDS=${CLEANUP_INTERVAL_SECONDS:-300}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - CONTAINER_MEMORY_LIMIT=${CONTAINER_MEMORY_LIMIT:-512m}
      - CONTAINER_CPU_LIMIT=${CONTAINER_CPU_LIMIT:-1.0}
      # 动态容器网络配置
      - ENABLE_DYNAMIC_NETWORKING=${ENABLE_DYNAMIC_NETWORKING:-true}
      - CONTAINER_NETWORK_MODE=${CONTAINER_NETWORK_MODE:-game-network}
      # Docker连接配置
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
      - factory_logs:/app/logs
      - factory_data:/app/data
    depends_on:
      matchmaker:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - game-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # 特权模式用于Docker容器管理
    privileged: false
    # 添加必要的capabilities
    cap_add:
      - NET_ADMIN

  # 示例游戏服务器（可选 - 仅用于演示和测试）
  # 注意: 生产环境中，游戏服务器由 game-server-factory 动态创建
  # 此服务仅作为参考实现和系统测试使用
  example-game-server:
    build: ./game_server_template
    ports:
      - "${EXAMPLE_SERVER_PORT:-8081}:8080"
    environment:
      - PORT=8080
      - MATCHMAKER_URL=http://matchmaker:8000
      - ROOM_NAME=${EXAMPLE_ROOM_NAME:-示例游戏房间}
      - ROOM_PASSWORD=${EXAMPLE_ROOM_PASSWORD:-}
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-25000}
      - RETRY_INTERVAL=${RETRY_INTERVAL:-5000}
      - MAX_PLAYERS=${EXAMPLE_MAX_PLAYERS:-20}
    depends_on:
      matchmaker:
        condition: service_healthy
      game-server-factory:
        condition: service_healthy
    networks:
      - game-network
    restart: unless-stopped
    profiles:
      - example  # 使用 --profile example 来启动示例服务器
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  game-network:
    external: true
    name: game-network

volumes:
  matchmaker_logs:
    driver: local
  factory_logs:
    driver: local
  factory_data:
    driver: local